@Library('jenkins-shared-library@develop') _

def ECR_IMAGE = 'public.ecr.aws/m1n8x9y9/techiescamp-repo:latest'
def PROJECT_DIR = 'infra/vpc'
def STATE_FILE = "vpc.tfstate"
def TF_VARS_FILE = 'vpc.tfvars'
def PLAN_FILE = 'tfplan.binary'
def PLAN_JSON_FILE = 'tfplan.json'
def TFVARS_FILE_PATH = '../../vars/infra/dev/vpc.tfvars'
def CUSTOM_POLICY = 'CUSTOM_AWS_*'
def NOTIFICATION_EMAIL = 'arunsample555@gmail.com'     

pipeline {
    agent {
        docker {
            image ECR_IMAGE
            args '-v /var/run/docker.sock:/var/run/docker.sock --privileged '
            reuseNode true
        }
    }

    parameters {
        choice(name: 'ACTION', choices: ['apply', 'destroy'], description: '')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                script {
                    terraformInit(
                        projectDirectory: PROJECT_DIR,
                        tfstateFile: STATE_FILE,
                        tfvarsFile: TF_VARS_FILE
                    )
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                script {
                    terraformValidate(
                        projectDirectory: PROJECT_DIR
                    )
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    terraformPlan(
                        projectDirectory: PROJECT_DIR,
                        variableFile: TF_VARS_FILE,
                        planFile: PLAN_FILE,
                        redirectPlanFile: PLAN_JSON_FILE
                    )
                }
            }
        }

        stage('Terraform Lint') {
            steps {
                script {
                    tfLint(
                        projectDirectory: PROJECT_DIR,
                        tfvarsFile: TFVARS_FILE_PATH
                    )
                }
            }
        }

        stage('Checkov Scan') {
            steps {
                script {
                    checkovScan(
                        projectDirectory: PROJECT_DIR,
                        planFileJson: PLAN_JSON_FILE,
                        customPolicy: CUSTOM_POLICY
                    )
                }
            }
        }

        stage('Terraform Apply') {
                  
            steps {
                script {
                    terraformApply(
                        projectDirectory: PROJECT_DIR,
                        variableFile: TF_VARS_FILE
                    )
                }
            }
        }

        stage('Terraform Destroy') {
            
            steps {
                script {
                    terraformDestroy(
                        projectDirectory: PROJECT_DIR,
                        variableFile: TF_VARS_FILE
                    )
                }
            }
        }
    }

    post {
        success {
            script {
                emailNotification.sendEmailNotification('success', NOTIFICATION_EMAIL)
            }
        }
        failure {
            script {
                emailNotification.sendEmailNotification('failure', NOTIFICATION_EMAIL)
            }
        }
    }
}
